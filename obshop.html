<!DOCTYPE html>
<html lang="en">
<!--   

Task list
=========

Think about code reuse and start on shopping module

Here it is, obShop

Simple at the moment.

1. Add new
2. Ordering a-z most used
3. user selection ( default )


-->



<head>
  <meta charset="UTF-8">
  <title>GoShop</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>



  <link id="theCss" rel="stylesheet" href="./obshop.css">



</head>



<body>

  OBSHOP 1.0a



  <div id="topDiv" class="topDiv fixed">
    <button onclick="saveToDisk()">save to disk</button>
    <button onclick="loadFromDisk()">load from disk</button>
    <div class="goDiv">
      <button class="bg-light goBadge" onclick="DoDeleteButton()">
        <image src="images/trash.png" style="width:30px; height:30px">
      </button>
      <button class="bg-light goBadge">
        <image src="images/plus.png" onclick="DoNewButton()" style="width:30px; height:30px">
      </button>

      <button onclick="DoUpdateButton()" class="bg-light goBadge" style="width:55px;height:55px;padding:0px">

        <image src="images/ok.png" style="width:45px; height:45px">
      </button>

      <button class="bg-light goBadge" onclick="itemUp()" style="float:right">
        <image src="images/up.png" style="width:30px; height:30px">
      </button>
      <button class="bg-light goBadge" onclick="itemDown()" style="float:left;transform: rotate(180deg);">
        <image src="images/up.png" style="width:30px; height:30px">
      </button>

      <div class="inputDiv">


        <table style="margin:auto;width:80%">
          <tr>
            <td>Name</td>

            <td>
              <input id="itemName" oninput="DoUpdateButton()" type="text" size="10" maxlength="18">
            </td>

          </tr>

          <tr>
            <td>in stock</td>
            <td>

              <button onclick="inStock.value--;DoUpdateButton()" style="margin-left:10px">-</button>
              <input type="number" id="inStock" onclick="inStock.select()" value="0" min="-10" max="100" size="3"
                maxlength="3">
              <button onclick="inStock.value++;DoUpdateButton()">+</button>

            </td>
          </tr>

          <tr>
            <td>to buy</td>
            <td>
              <div style="display:flexbox;">
                <button onclick="toBuy.value--;DoUpdateButton()" style="margin-left:10px">-</button>
                <input type="number" id="toBuy" onclick="toBuy.select()" value="0" min="-10" max="100" size="3"
                  maxlength="3">
                <button onclick="toBuy.value++;DoUpdateButton()">+</button>
              </div>

            </td>
          </tr>

        </table>




      </div>
    </div>
    <div id="divItems"></div>
    <div id="divProduct"></div>


  </div>


</body>

<!--







-->



<script>

  const Alert = {
    show(message) {
      alertText.innerHTML = "<h3>" + message + "</h3>";
      alertBox.classList.add("animate");
    },

  }

  function gid(id) {
    return document.getElementById(id);
  }
  function getFocusId() {
    let arr = document.getElementsByClassName("hasFocus");
    if (!arr.length) return null;
    let selected = arr[0];
    let id = selected.id;

    let a = id.split("_");
    return a[1];
  }

  function getIndexById(thisId) {

    for (let i = 0; i < Global.itemArray.length; i++) {
      if (thisId == Global.itemArray[i].id) {
        return i;
        break;
      }
    }

  }

  function DoDeleteButton() {
    let itBe;
    if (itBe = getFocusId()) {
      Global.itemArray.splice(getIndexById(itBe), 1);
      clearFocus();
      displayList(Global.itemArray, gid("divItems"), "item");

      itemName.value = "";
      toBuy.value = 0;
      inStock.value = 0;
    }
  }



  function formToArray(index) {
    Global.itemArray[index].name = itemName.value;
    Global.itemArray[index].inStock = inStock.value;
    Global.itemArray[index].toBuy = toBuy.value;

    displayList(Global.itemArray, gid("divItems"), "item");
  }

  // form to item
  function DoUpdateButton() {


    let thisId = getFocusId();
    if (!thisId) {
      alert("select an item, or click + in menu");
      return;
    }


    for (let i = 0; i < Global.itemArray.length; i++) {
      if (thisId == Global.itemArray[i].id) {
        formToArray(i);
        break;
      }
    }

  }

  function DoNewButton() {

    newItem = new (item);

    newItem.name = "new item";
    Global.itemArray.unshift(newItem);

    buttonToForm(newItem);

    displayList(Global.itemArray, gid("divItems"), "item");

    clearFocus();
    (gid("item_" + newItem.id)).classList.add('hasFocus');

    alert("added a new item");

  }

  function itemUp() {

    let id = getFocusId();
    if (!id) {
      alert("select an item, or select + in menu");
      return;
    }

    idx = getIndexById(id);

    if (!idx) return;
    let thisItemIndex = Global.itemArray[idx];

    Global.itemArray[idx] = Global.itemArray[idx - 1];
    Global.itemArray[idx - 1] = thisItemIndex;

    clearFocus();

    displayList(Global.itemArray, gid("divItems"), "item");

    (gid("item_" + id)).classList.add('hasFocus');

  }

  function itemDown() {

    let id = getFocusId();
    if (!id) {
      alert("select an item, or select + to add a new item");
      return;
    }

    let idx = getIndexById(id);

    if (idx + 1 == Global.itemArray.length) return;
    let thisItemIndex = Global.itemArray[idx];

    Global.itemArray[idx] = Global.itemArray[idx + 1];
    Global.itemArray[idx + 1] = thisItemIndex;


    clearFocus();

    displayList(Global.itemArray, gid("divItems"), "item");

    (gid("item_" + id)).classList.add('hasFocus');
  }

  const Global = {
    itemArray: [],
    productArray: [],
    depotArray: [],
    superArray: []
  };

  function clearFocus() {
    let arr = document.getElementsByClassName("btn-item");
    for (let i = 0; i < arr.length; i++) {
      arr[i].classList.remove("hasFocus");
    }
  }

  function buttonToForm(item) {
    itemName.value = item.name;
    inStock.value = item.inStock;
    toBuy.value = item.toBuy;

  }

  function selectButton(e) {

    function getItemById(id) {

      let a = id.split("_");
      let thisId = a[1];
      Global.itemArray.forEach
        (item => {
          if (item.id == thisId) {

            buttonToForm(item);

          }
        });
    }


    clearFocus();
    e.currentTarget.classList.add("hasFocus");

    let thisId = e.currentTarget.id;
    let thisItem = getItemById(thisId);

  }

  class obObject {
    constructor(type) {  // Class constructor
      this._type = type;  // Class body/properties
    }
    get(type) { return this._type }
  }

  class obButton extends obObject {
    constructor() {
      super('obButton');
      this.model = mod;
    }


  }

  function getStamp() {

    let x = Math.random() * 10000000000;
    x = x.toFixed(0);
    return x;
  }

  class item {
    constructor(name) {
      this._id = getStamp();
      if (!name)
        this._name = "unknown";
      else this._name = name;
      this._description = "unknown";
      this._inStock = 0;
      this._toBuy = 0;
    }
    get id() {
      return this._id;
    }
    set name(newName) {
      this._name = newName
    }
    get name() {
      return this._name;
    }
    set name(newName) {
      this._name = newName
    }
    get description() {
      return this._description;
    }
    set description(newDescription) {
      this._description = newDescription;
    }
    get inStock() {
      return this._inStock;
    }
    set inStock(newInStock) {
      this._inStock = newInStock;
    }
    get toBuy() {
      return this._toBuy;
    }
    set toBuy(newToBuy) {
      this._toBuy = newToBuy;;
    }

  }

  let a = [];

  for (let i = 0; i < 20; i++) {
    t = "item " + i;
    test = new item(t);
    Global.itemArray.push(test); // the working array
  }


  Global.productArray = Global.itemArray;

  function displayList(a, theDiv, type) {

    let focus = getFocusId();
    divItems.innerHTML = "";
    a.forEach(item => {
      // console.log(item.name);

      let newButton = document.createElement('button');
      theDiv.appendChild(newButton);

      buttonId = type + "_" + item.id;
      newButton.id = buttonId;
      newButton.classList.add("btn");
      newButton.classList.add("btn-success");
      newButton.classList.add("btn-" + type);
      newButton.innerHTML = item.name + `<span class="badge bg-primary inBadge" style="float:left">`
        + item.inStock + `</span><span class="badge bg-primary inBadge" style="float:right">` + item.toBuy + `</span>`

      const element = gid(buttonId);
      newButton.addEventListener("click", selectButton);

    });

    if (focus) {
      (gid("item_" + focus)).classList.add("hasFocus");
    }
  }

  //buttonColor = `btn btn-success`;



  const x = Global.itemArray;

  displayList(Global.itemArray, gid("divItems"), "item");

  const gItemArray = [];


  function saveToDisk() {
    const theData = JSON.stringify(Global.itemArray);

    const xhttp = new XMLHttpRequest();
    var req = "savetodisk.php";
    // let user = User.get();
    //if (user)

    user = "TESTUSER";
    req += "?filename=" + "autosave_" + user + ".txt";
    ///alert(user + ' save');
    xhttp.open("POST", req);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.onload = function () {
      alert("done save");
    }
    xhttp.send("data=" + theData);
  }


  function loadFromDisk() {

    const xhttp = new XMLHttpRequest();
    let req = "loadfromdisk.php";
    let user = "TESTUSER";

    req += "?filename=" + "autosave_" + user + ".txt";
    xhttp.open("POST", req);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.onload = function () {

      let json =  this.responseText;
      Global.itemArray = JSON.parse(json);

      displayList(Global.itemArray, gid("divItems"), "item");
      alert("done load from disk ");

    }
    xhttp.send();
  }

</script>


</html>